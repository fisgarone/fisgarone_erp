{% extends "base.html" %}

{% block title %}Dashboard Executivo â€¢ FISGARONE ERP{% endblock %}
{% block page_title %}Dashboard Executivo{% endblock %}

{% block content %}
    <!-- NÃ³ de configuraÃ§Ã£o nÃ£o-visual para os componentes JS -->
    <div id="dashboard-config"
         data-filters-url="/api/filters/accounts"
         data-summary-url="/api/dashboard/summary"
         data-default-period="month_to_date"
         hidden></div>

    <!-- LINHA 1: MÃ‰TRICAS EM TEMPO REAL -->
    <section class="ai-section">
        <div class="section-header">
            <div class="header-content">
                <h2 class="section-title">ğŸ“Š MÃ©tricas em Tempo Real</h2>
                <p class="section-subtitle">Dados atualizados automaticamente</p>
            </div>
            <div class="header-actions">
                <button class="ai-btn ai-btn-secondary" id="btn-exportar">
                    ğŸ“¥ Exportar
                </button>
                <button class="ai-btn ai-btn-primary btn-with-icon" id="btn-atualizar">
                    <span>ğŸ”„</span>
                    Atualizar Dados
                </button>
            </div>
        </div>
        <!-- container consumido pelo dashboard-manager -->
        <div class="metrics-top-grid" id="kpi-container"></div>
    </section>

    <!-- FILTROS -->
    <section class="ai-section">
        <div class="section-header">
            <h2 class="section-title">ğŸ›ï¸ Filtros AvanÃ§ados</h2>
        </div>
        <!-- o componente filters-system deve montar o HTML aqui -->
        <div id="filters-container"></div>
    </section>

    <!-- INSIGHTS / ANALYTICS -->
    <section class="ai-section">
        <div class="insights-analytics-grid">
            <div>
                <h2 class="section-title">ğŸ¤– Insights Inteligentes</h2>
                <div id="insights-container"></div>
            </div>
            <div>
                <h2 class="section-title">ğŸ“ˆ Analytics AvanÃ§ados</h2>
                <div id="analytics-container"></div>
            </div>
        </div>
    </section>

    <!-- CHARTS -->
    <section class="ai-section">
        <h2 class="section-title">ğŸ“Š VisualizaÃ§Ãµes GrÃ¡ficas</h2>
        <div class="visualizations-full" id="charts-container"></div>
    </section>

    <!-- ABC / DISTRIBUIÃ‡ÃƒO -->
    <section class="ai-section">
        <div class="products-distribution-grid">
            <div>
                <h2 class="section-title">ğŸ† Top Produtos - AnÃ¡lise ABC</h2>
                <div id="abc-container"></div>
            </div>
            <div>
                <h2 class="section-title">ğŸ“Š DistribuiÃ§Ã£o por ClassificaÃ§Ã£o</h2>
                <div id="distribution-container"></div>
            </div>
        </div>
    </section>

    <!-- MÃ‰TRICAS ESTRATÃ‰GICAS -->
    <section class="ai-section">
        <h2 class="section-title">ğŸ“ˆ MÃ©tricas EstratÃ©gicas</h2>
        <div class="metrics-top-grid" id="strategic-container"></div>
    </section>

    <!-- UX -->
    <button class="floating-action" onclick="dashboard?.scrollToTop?.()" title="Voltar ao topo">â†‘</button>
{% endblock %}

{% block scripts %}
    {# Ordem preservada; todos com defer #}
    <script src="{{ url_for('static', filename='js/core/ai-engine.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/services/api-integration.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/components/modal-system.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/components/filters-system.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/components/charts-system.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/components/dashboard-manager.js') }}" defer></script>

    <!-- Bridge de configuraÃ§Ã£o (nÃ£o altera seus .js; apenas disponibiliza contexto) -->
    <script defer>
      window.addEventListener('DOMContentLoaded', async () => {
        // publica configuraÃ§Ã£o lida do nÃ³ data-* para quem precisar
        const cfgEl = document.getElementById('dashboard-config');
        window.__DASHBOARD_CONFIG__ = {
          filtersUrl:  cfgEl?.dataset?.filtersUrl  || '/api/filters/accounts',
          summaryUrl:  cfgEl?.dataset?.summaryUrl  || '/api/dashboard/summary',
          defaultPeriod: cfgEl?.dataset?.defaultPeriod || 'month_to_date'
        };

        // instancia o manager se ainda nÃ£o existir
        if (!window.dashboard && typeof DashboardManager === 'function') {
          window.dashboard = new DashboardManager({
            // os componentes podem optar por ler daqui ou de window.__DASHBOARD_CONFIG__
            filtersUrl: window.__DASHBOARD_CONFIG__.filtersUrl,
            summaryUrl: window.__DASHBOARD_CONFIG__.summaryUrl,
            defaultPeriod: window.__DASHBOARD_CONFIG__.defaultPeriod,
            anchors: {
              kpis: '#kpi-container',
              filters: '#filters-container',
              charts: '#charts-container',
              insights: '#insights-container',
              analytics: '#analytics-container',
              abc: '#abc-container',
              distribution: '#distribution-container',
              strategic: '#strategic-container'
            },
            // callbacks opcionais para botÃµes do header
            buttons: {
              refresh: '#btn-atualizar',
              export:  '#btn-exportar'
            }
          });
        }

        // inicializaÃ§Ã£o padrÃ£o e bind de botÃµes (idempotente)
        try { await window.dashboard.initialize(); } catch (e) { console.error('dashboard.initialize()', e); }
        try {
          document.querySelector('#btn-atualizar')?.addEventListener('click', () => window.dashboard.refreshData?.());
          document.querySelector('#btn-exportar')?.addEventListener('click', () => window.dashboard.exportData?.());
        } catch(e) { console.error('bind header buttons', e); }
      });
    </script>
{% endblock %}

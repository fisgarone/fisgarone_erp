{% extends "base.html" %}

{% block title %}Dashboard Executivo â€¢ FISGARONE ERP{% endblock %}
{% block page_title %}Dashboard Executivo{% endblock %}

{% block content %}
    {# NÃ³ de configuraÃ§Ã£o para os componentes JS (nÃ£o-visual) #}
    <div id="dashboard-config"
         data-filters-url="/api/filters/accounts"
         data-summary-url="/api/dashboard/summary"
         data-default-period="month_to_date"
         hidden></div>

    <!-- LINHA 1: MÃ‰TRICAS EM TEMPO REAL -->
    <section class="ai-section">
        <div class="section-header">
            <div class="header-content">
                <h2 class="section-title">ğŸ“Š MÃ©tricas em Tempo Real</h2>
                <p class="section-subtitle">Dados atualizados automaticamente</p>
            </div>
            <div class="header-actions">
                <button class="ai-btn ai-btn-secondary" id="btn-exportar">
                    ğŸ“¥ Exportar
                </button>
                <button class="ai-btn ai-btn-primary btn-with-icon" id="btn-atualizar">
                    <span>ğŸ”„</span>
                    Atualizar Dados
                </button>
            </div>
        </div>
        <div class="metrics-top-grid" id="kpi-container"></div>
    </section>

    <!-- FILTROS AVANÃ‡ADOS -->
    <section class="ai-section">
        <div class="section-header">
            <h2 class="section-title">ğŸ›ï¸ Filtros AvanÃ§ados</h2>
        </div>
        <div id="filters-container"></div>
    </section>

    <!-- INSIGHTS / ANALYTICS -->
    <section class="ai-section">
        <div class="insights-analytics-grid">
            <div>
                <h2 class="section-title">ğŸ¤– Insights Inteligentes</h2>
                <div id="insights-container"></div>
            </div>
            <div>
                <h2 class="section-title">ğŸ“ˆ Analytics AvanÃ§ados</h2>
                <div id="analytics-container"></div>
            </div>
        </div>
    </section>

    <!-- CHARTS -->
    <section class="ai-section">
        <h2 class="section-title">ğŸ“Š VisualizaÃ§Ãµes GrÃ¡ficas</h2>
        <div class="visualizations-full" id="charts-container"></div>
    </section>

    <!-- ABC / DISTRIBUIÃ‡ÃƒO -->
    <section class="ai-section">
        <div class="products-distribution-grid">
            <div>
                <h2 class="section-title">ğŸ† Top Produtos - AnÃ¡lise ABC</h2>
                <div id="abc-container"></div>
            </div>
            <div>
                <h2 class="section-title">ğŸ“Š DistribuiÃ§Ã£o por ClassificaÃ§Ã£o</h2>
                <div id="distribution-container"></div>
            </div>
        </div>
    </section>

    <!-- MÃ‰TRICAS ESTRATÃ‰GICAS -->
    <section class="ai-section">
        <h2 class="section-title">ğŸ“ˆ MÃ©tricas EstratÃ©gicas</h2>
        <div class="metrics-top-grid" id="strategic-container"></div>
    </section>

    <button class="floating-action" onclick="window.dashboard?.scrollToTop?.()" title="Voltar ao topo">â†‘</button>
{% endblock %}

{% block scripts %}
    {# Ordem original, sem alterar seus assets globais #}
    <script src="{{ url_for('static', filename='js/core/ai-engine.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/services/api-integration.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/components/modal-system.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/components/filters-system.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/components/charts-system.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/components/dashboard-manager.js') }}" defer></script>

    <!-- Bridge de configuraÃ§Ã£o + fixes de filtro/contas e perÃ­odo padrÃ£o -->
    <script defer>
      (function () {
        const cfgEl = document.getElementById('dashboard-config') || {};
        const CFG = {
          filtersUrl:   cfgEl.dataset?.filtersUrl   || '/api/filters/accounts',
          summaryUrl:   cfgEl.dataset?.summaryUrl   || '/api/dashboard/summary',
          defaultPeriod:cfgEl.dataset?.defaultPeriod|| 'month_to_date'
        };
        // Expor de forma explÃ­cita e auditÃ¡vel
        window.__DASHBOARD_CONFIG__ = CFG;

        // UtilitÃ¡rios de formato
        const brl = n => {
          try { return Number(n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
          catch { return 'R$ 0,00'; }
        };
        const intf = n => {
          try { return Number(n||0).toLocaleString('pt-BR'); }
          catch { return '0'; }
        };

        // Aplica filtros ao backend via querystring (period/account/...)
        async function refreshSummaryWithFilters() {
          try {
            if (!window.dashboard?.getFilters) return; // respeita sua implementaÃ§Ã£o
            const f = window.dashboard.getFilters(CFG) || {};
            // Garantir padrÃ£o "mÃªs corrente" na ausÃªncia de escolha
            f.period = f.period || CFG.defaultPeriod;

            const qs = new URLSearchParams({
              period:  f.period || '',
              account: f.account || '',
              status:  f.status || '',
              category:f.category || ''
            }).toString();

            const r = await fetch(`${CFG.summaryUrl}?${qs}`, { cache: 'no-store' });
            if (!r.ok) throw new Error('summary endpoint not ok');
            const d = await r.json();

            // Se seu dashboard-manager renderiza os cards sozinho, delegue:
            if (typeof window.dashboard.renderSummary === 'function') {
              return window.dashboard.renderSummary(d, { brl, intf });
            }

            // Fallback nÃ£o-intrusivo: tenta IDs padrÃ£o usados no projeto
            document.getElementById('card_total_vendas')?.textContent = intf(d.total_vendas);
            document.getElementById('card_fat_bruto')?.textContent    = brl(d.faturamento_bruto);
            document.getElementById('card_fat_liquido')?.textContent  = brl(d.faturamento_liquido);
            document.getElementById('card_ticket_medio')?.textContent = brl(d.ticket_medio);
            document.getElementById('card_lucro')?.textContent        = brl(d.lucro);
          } catch (e) {
            console.error('refreshSummaryWithFilters', e);
          }
        }

        // Popula o select de Conta ML (nÃ£o-intrusivo; sÃ³ incrementa)
        async function ensureMlAccountsSelectPopulated() {
          try {
            const r = await fetch(CFG.filtersUrl, { cache: 'no-store' });
            if (!r.ok) throw new Error('filters endpoint not ok');
            const data = await r.json();
            const accounts = (data && data.mercado_livre) || [];
            if (!accounts.length) return;

            // Procura um select destinado Ã  conta ML
            // Tentamos por id conhecido, depois por data-attr, depois por label
            let sel =
              document.getElementById('mlAccountSelect') ||
              document.querySelector('select[data-role="ml-account"]') ||
              Array.from(document.querySelectorAll('#filters-container select')).find(s => {
                const id = (s.id||'').toLowerCase();
                const name = (s.name||'').toLowerCase();
                return id.includes('ml') && id.includes('account') || name.includes('ml');
              });

            if (!sel) return; // se o componente nÃ£o expÃµe select, nÃ£o forÃ§amos nada

            // NÃ£o duplicar opÃ§Ãµes se jÃ¡ foi populado corretamente
            const existing = new Set(Array.from(sel.options).map(o => (o.value||'').toUpperCase()));
            let changed = false;

            // Garante opÃ§Ã£o "todas"
            if (!existing.has('')) {
              const optAll = document.createElement('option');
              optAll.value = '';
              optAll.textContent = 'Todas as Contas';
              sel.insertBefore(optAll, sel.firstChild);
              changed = true;
            }

            // Adiciona as contas que faltarem
            for (const a of accounts) {
              const val = (a.label || a.index || '').toString().toUpperCase();
              if (!val) continue;
              if (!existing.has(val)) {
                const opt = document.createElement('option');
                opt.value = a.label || a.index || '';
                opt.textContent = a.label || `ML-${a.index}`;
                sel.appendChild(opt);
                changed = true;
              }
            }

            // Se alterou opÃ§Ãµes e o dashboard tiver hook para reagir
            if (changed && typeof window.dashboard?.onAccountsOptionsChanged === 'function') {
              window.dashboard.onAccountsOptionsChanged(sel);
            }
          } catch (e) {
            console.error('ensureMlAccountsSelectPopulated', e);
          }
        }

        // Bind dos botÃµes do header
        function bindHeaderButtons() {
          document.getElementById('btn-atualizar')?.addEventListener('click', () => {
            // Respeita o refresh interno do dashboard; se existir, delega
            if (typeof window.dashboard?.refreshData === 'function') {
              return window.dashboard.refreshData();
            }
            // senÃ£o, garante aplicaÃ§Ã£o dos filtros no resumo
            refreshSummaryWithFilters();
          });
          document.getElementById('btn-exportar')?.addEventListener('click', () => {
            if (typeof window.dashboard?.exportData === 'function') {
              return window.dashboard.exportData();
            }
          });
        }

        // Bootstrap idempotente
        window.addEventListener('DOMContentLoaded', async () => {
          try {
            if (!window.dashboard && typeof window.DashboardManager === 'function') {
              window.dashboard = new window.DashboardManager({
                filtersUrl: CFG.filtersUrl,
                summaryUrl: CFG.summaryUrl,
                defaultPeriod: CFG.defaultPeriod,
                anchors: {
                  kpis: '#kpi-container',
                  filters: '#filters-container',
                  charts: '#charts-container',
                  insights: '#insights-container',
                  analytics: '#analytics-container',
                  abc: '#abc-container',
                  distribution: '#distribution-container',
                  strategic: '#strategic-container'
                }
              });
            }
            if (typeof window.dashboard?.initialize === 'function') {
              await window.dashboard.initialize();
            }

            bindHeaderButtons();
            await ensureMlAccountsSelectPopulated();   // garante TOYS/COMERCIAL/PESCA/CAMPING no select
            await refreshSummaryWithFilters();         // aplica "mÃªs corrente" ao carregar
          } catch (e) {
            console.error('dashboard bootstrap', e);
          }
        });
      })();
    </script>
{% endblock %}
